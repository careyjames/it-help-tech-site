name: Performance Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm install

      - name: Install Zola
        uses: taiki-e/install-action@cargo-binstall
        with:
          tool: zola

      - name: Build site with Zola
        run: |
          zola build
          if [ ! -d "public" ]; then
            echo "❌ Build failed - public directory not created"
            exit 1
          fi

      - name: Purge unused CSS
        run: |
          npx purgecss --css public/css/*.css --content public/**/*.html --output public/css/ --safelist "phone-line"
          
      - name: Copy static assets
        run: ./scripts/copy-assets.sh

      - name: Run Lighthouse CI Performance Check
        id: lighthouse
        run: |
          # Set up cleanup trap
          cleanup() {
            if [ ! -z "$SERVER_PID" ]; then
              kill $SERVER_PID 2>/dev/null || true
              echo "🧹 Server cleaned up"
            fi
          }
          trap cleanup EXIT INT TERM
          
          # Start HTTP server
          echo "🚀 Starting server..."
          npx http-server public -p 8080 -s &
          SERVER_PID=$!
          
          # Wait for server with timeout
          echo "⏳ Waiting for server to start..."
          for i in {1..10}; do
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "✅ Server is ready"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "❌ Server failed to start"
              exit 1
            fi
            sleep 1
          done
          
          # Run Lighthouse with better error handling
          echo "🔍 Running Lighthouse CI..."
          if npx lhci autorun --config=.lighthouserc.js; then
            echo "✅ Performance gates passed"
          else
            echo "❌ Performance gates failed - PR blocked"
            exit 1
          fi
        env:
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.pull_request.head.sha }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.pull_request.updated_at }}

      - name: Generate Performance Summary
        if: always()
        id: performance-summary
        run: |
          # Start building the performance report
          echo "## 🚀 Lighthouse Performance Results" > performance-summary.md
          echo "" >> performance-summary.md

          # Add Lighthouse results section
          if [ -d ".lighthouseci" ]; then
            # Find the latest results
            RESULTS_DIR=$(find .lighthouseci -name "lhr-*.json" | head -1)
            if [ -n "$RESULTS_DIR" ]; then
              # Extract key metrics for summary
              echo "LIGHTHOUSE_RESULTS_FOUND=true" >> $GITHUB_OUTPUT
              if [ "${{ steps.lighthouse.outcome }}" = "success" ]; then
                echo "✅ **All performance gates passed!**" >> performance-summary.md
                echo "" >> performance-summary.md
                echo "Your changes meet the performance requirements:" >> performance-summary.md
                echo "- Performance: ≥85 ✅" >> performance-summary.md
                echo "- Best Practices: ≥90 ✅" >> performance-summary.md
                echo "- SEO: ≥90 ✅" >> performance-summary.md
                echo "- LCP: <3.0s ✅" >> performance-summary.md
                echo "- CLS: <0.2 ✅" >> performance-summary.md
              else
                echo "❌ **Performance gates failed**" >> performance-summary.md
                echo "" >> performance-summary.md
                echo "Some performance requirements were not met. Please review the detailed reports." >> performance-summary.md
                echo "" >> performance-summary.md
                echo "**Required thresholds:**" >> performance-summary.md
                echo "- Performance: ≥85" >> performance-summary.md
                echo "- Best Practices: ≥90" >> performance-summary.md
                echo "- SEO: ≥90" >> performance-summary.md
                echo "- LCP: <3.0s" >> performance-summary.md
                echo "- CLS: <0.2" >> performance-summary.md
                echo "" >> performance-summary.md
                echo "💡 **Tips for improvement:**" >> performance-summary.md
                echo "- Run \`./scripts/validate-lighthouse.sh\` locally to test" >> performance-summary.md
                echo "- Check detailed reports in the workflow artifacts" >> performance-summary.md
                echo "- Review image optimization and CSS bundle size" >> performance-summary.md
              fi

              echo "" >> performance-summary.md
              echo "📊 **Pages tested:**" >> performance-summary.md
              echo "- Homepage, Services, Billing, About, Blog" >> performance-summary.md
            else
              echo "LIGHTHOUSE_RESULTS_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "LIGHTHOUSE_RESULTS_FOUND=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Performance Results
        if: always() && steps.performance-summary.outputs.LIGHTHOUSE_RESULTS_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const summary = fs.readFileSync('performance-summary.md', 'utf8');

              // Find existing performance comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const existingComment = comments.find(comment =>
                comment.body.includes('🚀 Lighthouse Performance Results')
              );
              
              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: summary
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: summary
                });
              }
            } catch (error) {
              console.log('Could not post comment:', error);
            }

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

