name: Lighthouse Performance Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lighthouse-performance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm install

      - name: Install Zola
        uses: taiki-e/install-action@cd39cb0572834c149bf3533a143f05e09def0f3c # v2.62.2
        with:
          tool: zola

      - name: Build site with Zola
        run: |
          zola build
          if [ ! -d "public" ]; then
            echo "âŒ Build failed - public directory not created"
            exit 1
          fi

      - name: Purge unused CSS
        run: |
          npx purgecss --css public/css/*.css --content public/**/*.html --output public/css/ --safelist "phone-line"

      - name: Copy static assets
        run: ./scripts/copy-assets.sh

      - name: Run Lighthouse Performance Tests
        id: lighthouse
        run: |
          echo "ðŸš€ Running Lighthouse performance tests..."
          if npm run lighthouse; then
            echo "âœ… Performance tests passed"
            echo "LIGHTHOUSE_STATUS=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Performance tests failed - PR blocked"
            echo "LIGHTHOUSE_STATUS=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.pull_request.head.sha }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.pull_request.updated_at }}

      - name: Generate Lighthouse Performance Summary
        if: always()
        id: lighthouse-summary
        run: |
          echo "## ðŸš€ Lighthouse Performance Results" > lighthouse-summary.md
          echo "" >> lighthouse-summary.md

          if [ "${{ steps.lighthouse.outcome }}" = "success" ]; then
            echo "âœ… **All performance gates passed!**" >> lighthouse-summary.md
            echo "" >> lighthouse-summary.md
            echo "Your changes meet performance standards:" >> lighthouse-summary.md
          else
            echo "âŒ **Performance requirements not met**" >> lighthouse-summary.md
            echo "" >> lighthouse-summary.md
            echo "Some performance thresholds were not reached. Please review the detailed reports." >> lighthouse-summary.md
            echo "" >> lighthouse-summary.md
          fi

          # Add performance thresholds information (updated to match .lighthouserc.js)
          echo "**Performance Requirements:**" >> lighthouse-summary.md
          echo "- **Performance**: â‰¥90 (blocks PR)" >> lighthouse-summary.md
          echo "- **LCP**: <2.5s (blocks PR)" >> lighthouse-summary.md
          echo "- **FCP**: <1.2s (blocks PR)" >> lighthouse-summary.md
          echo "- **CLS**: <0.1 (blocks PR)" >> lighthouse-summary.md
          echo "- **Accessibility**: â‰¥95 (warning)" >> lighthouse-summary.md
          echo "- **Best Practices**: â‰¥95 (warning)" >> lighthouse-summary.md
          echo "- **SEO**: â‰¥95 (warning)" >> lighthouse-summary.md
          echo "- **TBT**: <300ms (warning)" >> lighthouse-summary.md
          echo "" >> lighthouse-summary.md

          # Add lighthouse reports links if available
          if [ -d ".lighthouseci" ]; then
            echo "ðŸ“‹ **Detailed Lighthouse reports**: Check workflow artifacts for \`.lighthouseci/\`" >> lighthouse-summary.md
            echo "LIGHTHOUSE_RESULTS_FOUND=true" >> $GITHUB_OUTPUT
          else
            echo "LIGHTHOUSE_RESULTS_FOUND=false" >> $GITHUB_OUTPUT
          fi

          echo "" >> lighthouse-summary.md
          echo "**Pages tested:** Homepage, Services, Billing, About, Blog" >> lighthouse-summary.md
          echo "" >> lighthouse-summary.md
          echo "ðŸ’¡ **Tips for improvement:**" >> lighthouse-summary.md
          echo "- Run \`npm run lighthouse\` locally to test before pushing" >> lighthouse-summary.md
          echo "- Check the [Web Vitals](https://web.dev/vitals/) guide for optimization tips" >> lighthouse-summary.md
          echo "- Use Chrome DevTools Lighthouse panel for real-time testing" >> lighthouse-summary.md

      - name: Comment PR with Lighthouse Results
        if: always() && steps.lighthouse-summary.outputs.LIGHTHOUSE_RESULTS_FOUND == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');

            try {
              const summary = fs.readFileSync('lighthouse-summary.md', 'utf8');

              // Find existing lighthouse comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const existingComment = comments.find(comment =>
                comment.body.includes('ðŸš€ Lighthouse Performance Results')
              );

              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: summary
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: summary
                });
              }
            } catch (error) {
              console.log('Could not post lighthouse comment:', error);
            }

      - name: Upload Lighthouse Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lighthouse-summary.md
          retention-days: 30

